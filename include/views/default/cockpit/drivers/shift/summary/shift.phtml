<?php 
	$shift = $this->shift;
?>
<div class="row-fluid">
	<div class="container-fluid">
		<div class="row-fluid">
			<div class="span12">
						<form>
							<input type="hidden" value="<?php echo $shift->id_community_shift; ?>" id="id_community_shift" name="id_community_shift" />
							<div class="row-fluid">
								<div class="span12">
									<div class="span2">
										Community:
									</div>
									<div class="span7">
										<strong><?php echo $shift->community()->name; ?></strong>
									</div>
								</div>
							</div>
							<div class="row-fluid">
								<div class="span12">
									<div class="span2">
										Start at:
									</div>
									<div class="span7">
										<?php echo $shift->dateStart()->format( 'M jS Y ' ); ?>
										<strong><?php echo $shift->dateStart()->format( 'g:i A' ); ?></strong>
									</div>
								</div>
							</div>
							<div class="row-fluid">
								<div class="span12">
									<div class="span2">
										End at:
									</div>
									<div class="span7">
										<?php echo $shift->dateEnd()->format( 'M jS Y ' ); ?>
										<strong><?php echo $shift->dateEnd()->format( 'g:i A' ); ?></strong>
									</div>
								</div>
							</div>
							<div class="row-fluid">
								<div class="span12">
									<div class="span2">
										Timezone:
									</div>
									<div class="span7">
										<strong><?php echo $shift->timezone(); ?></strong>
									</div>
								</div>
							</div>
							<div class="box-content" style="border:1px solid #cdcdcd;">
								<table width="100%" class="table table-normal">
									<thead>
										<tr>
											<td style="width:25px;"></td>
											<td style="width:100px;">Driver</td>
											<td style="width:60px;">Ranking</td>
											<td>Shifts wants to work</td>
											<td>Total assigned shifts</td>
										</tr>
									</thead>
									<tbody>
									<?php 
									$alreadyShown = [];
									$driversDontWantWorkHere = [];
									$preferences = $shift->getAdminPreferences();
									$hasDrivers = false;
									$week = $shift->week();
									$year = $shift->year();
									foreach( $preferences as $preference ){ 
										if( intval( $preference->ranking ) > 0 ){
											$hasDrivers = true;
										} else if( intval( $preference->ranking ) == 0 ){
											$driversDontWantWorkHere[] = $preference->admin();
										}
									}
									if( $hasDrivers ){
									?>
									<tr>
										<td colspan="5">
											<strong><center>Drivers that want to work at this shift</center></strong>
										</td>
									</tr>
									<?php
									$firstDayOfWeek = $shift->firstDayOfWeek()->format( 'Y-m-d' );
									$lastDayOfWeek = $shift->lastDayOfWeek()->format( 'Y-m-d' );
									foreach( $preferences as $preference ){ 
										$admin = $preference->admin();
										$alreadyShown[] = $admin->id_admin;
										if( $preference->ranking == 0 ){
											continue;
										}
										$status = Crunchbutton_Admin_Shift_Status::getByAdminWeekYear( $admin->id_admin, $week, $year );
										$checked = ( Crunchbutton_Admin_Shift_Assign::adminHasShift( $admin->id_admin, $shift->id_community_shift ) ) ? 'checked="checked"' : '';
										$adminShifts = Crunchbutton_Admin_Shift_Assign::shiftsByAdminPeriod( $admin->id_admin, $firstDayOfWeek, $lastDayOfWeek );
										$totalShifts = $adminShifts->count();
										?>
										<tr>
											<td>
												<input type="checkbox" class="icheck" <?php echo $checked; ?> value="<?php echo $admin->id_admin; ?>" name="form-id_admin" id="form-id_admin-<?php echo $admin->id_admin; ?>">
											</td>
											<td><?php echo $admin->name; ?> <br/><?php echo $admin->phone(); ?></td>
											<td><?php echo $preference->ranking; ?></td>
											<td><?php echo $status->shifts; ?></td>
											<td><?php echo $totalShifts; ?></td>
										</tr>
										<?php } 
										}
									?>
									<?php 
									$otherDrivers = $shift->community()->getDriversOfCommunity();
									$hasDrivers = false;
									foreach( $otherDrivers as $admin ){ 
										if( in_array( $admin->id_admin, $alreadyShown ) ){
											continue;
										}
										$hasDrivers = true;
									}
									if ( $hasDrivers ){
									?>
									<tr>
										<td colspan="5">
											<strong><center>Other drivers</center></strong>
										</td>
									</tr>
									<?php

									foreach( $otherDrivers as $admin ){ 
										if( in_array( $admin->id_admin, $alreadyShown ) ){
											continue;
										}
										$status = Crunchbutton_Admin_Shift_Status::getByAdminWeekYear( $admin->id_admin, $week, $year );
										$checked = ( Crunchbutton_Admin_Shift_Assign::adminHasShift( $admin->id_admin, $shift->id_community_shift ) ) ? 'checked="checked"' : '';
										$adminShifts = Crunchbutton_Admin_Shift_Assign::shiftsByAdminPeriod( $admin->id_admin, $firstDayOfWeek, $lastDayOfWeek );
										$totalShifts = $adminShifts->count();
										?>
										<tr>
											<td>
												<input type="checkbox" class="icheck" <?php echo $checked; ?> value="<?php echo $admin->id_admin; ?>" name="form-id_admin" id="form-id_admin-<?php echo $admin->id_admin; ?>">
											</td>
											<td><?php echo $admin->name; ?> <br/><?php echo $admin->phone(); ?></td>
											<td>-</td>
											<td><?php echo $status->shifts; ?></td>
											<td><?php echo $totalShifts; ?></td>
										</tr>
										<?php
										}
									}
									?>
									<?php if( count( $driversDontWantWorkHere ) > 0 ) { ?>
										<tr>
											<td colspan="5">
												<strong><center>Drivers that don't want to work at this shift</center></strong>
											</td>
										</tr>
										<?php
										foreach( $driversDontWantWorkHere as $admin ){ 
											$status = Crunchbutton_Admin_Shift_Status::getByAdminWeekYear( $admin->id_admin, $week, $year );
											$checked = ( Crunchbutton_Admin_Shift_Assign::adminHasShift( $admin->id_admin, $shift->id_community_shift ) ) ? 'checked="checked"' : '';
											$adminShifts = Crunchbutton_Admin_Shift_Assign::shiftsByAdminPeriod( $admin->id_admin, $firstDayOfWeek, $lastDayOfWeek );
											$totalShifts = $adminShifts->count();
											?>
											<tr>
												<td>
													<input type="checkbox" class="icheck" <?php echo $checked; ?> value="<?php echo $admin->id_admin; ?>" name="form-id_admin" id="form-id_admin-<?php echo $admin->id_admin; ?>">
												</td>
												<td><?php echo $admin->name; ?> <br/><?php echo $admin->phone(); ?></td>
												<td>-</td>
												<td><?php echo $status->shifts; ?></td>
												<td><?php echo $totalShifts; ?></td>
											</tr>
										<?php
										}
									 } ?>
									</tbody>
								</table>
							</div>
							
							<div class="row-fluid">
								<div class="row-fluid">
									<div class="span12">
										<br/>
									</div>
								</div>
								<div class="row-fluid">
									<div class="span6">
										<button type="button" onclick="shift.summary.assign.save();" class="btn btn-green"><i class="icon-save"></i> Save </button> 
									</div>
								</div>
							</div>
						</form>
					
		</div>
	</div>
</div>
<script type="text/javascript">
$( document ).ready( function(){
	shift.summary.assign.init();
} );
</script>