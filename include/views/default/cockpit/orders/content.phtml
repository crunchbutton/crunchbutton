<style>
.comments .ui-state-default {
	border: 0;
}
.list-orders.table-normal tbody td {
	vertical-align: top;
}
.list-orders a {
	text-decoration: underline;
}
</style>

<? if (!$this->orders->count()) : ?>
	No results found
<? else : ?>

	<table class="list-orders table table-normal">
		<thead>
			<tr>
				<td style="width:120px;">Info</td>
				<td style="width:95px;">Date</td>
				<td style="width:120px;">Restaurant</td>
				<td>Order</td>
				<td>Price</td>
				<td>Pay&nbsp;/&nbsp;Type</td>
				<td></td>
			</tr>
		</thead>

<?php 
$permissionRefund = c::admin()->permission()->check(['global','orders-all','orders-refund']);
$permissionNotification = c::admin()->permission()->check(['global','orders-all','orders-notification']);
$permissionGiftCard = c::admin()->permission()->check(['global','orders-all','gift-card-all','gift-card-crud']);
$permissionSupportCreate = c::admin()->permission()->check(['global','support-all','support-crud']);
$permissionSupportView = c::admin()->permission()->check(['global','support-all','support-crud', 'support-view']);
?>

		<? foreach ($this->orders as $order) :  /* @var $order Crunchbutton_Order */?>
			<? $date = $order->date(); ?>
			<tr class="list-order-item">
				<td>
					<a href="/vieworder/<?=$order->uuid?>">#<?=$order->id?></a>
					<br/>
					<br/>
					<?=$order->env?>
					<br/>
					<br/>

						<?php if( $permissionRefund ) { ?>
							<? if ($order->refunded) : ?>
								REFUNDED
							<? else : ?>
								<a href="javascript:;" class="refund" data-charged="<?php echo $order->charged(); ?>" data-gift="<?php if( $order->chargedByCredit() > 0 ){ echo $order->chargedByCredit(); } else { echo '0'; } ?>" data-uuid="<?=$order->uuid?>">REFUND
								</a>
							<? endif ; ?>
						<?php } ?>

							<?php 
							$credit = $order->hasCredit();
							if( $credit > 0 ){
								echo '<div style="color:red;margin-top:8px;">Received <strong style="font-weight:bold;">$' . number_format( $credit, 2 ) . '</strong> credit.</div>';
							}
							?>
							<?php 
							$giftcard = $order->hasGiftCard();
							if( $giftcard > 0 ){
								echo '<br/><br/><i class="icon-gift"></i> Received <b>$' . number_format( $giftcard, 2 ) . '</b> gift card.';
							}
							?>
							<br />
							<br /> 
							<?php if( $order->refunded ) { ?>
								<?php if( $permissionRefund ) { ?>
									<div class="pointer pay_if_refunded" data-value="<?php if( $order->pay_if_refunded ){ echo 1; } else { echo 0; } ?>" data-uuid="<?=$order->uuid?>">
										<span><?php if( $order->pay_if_refunded ) { echo '<i class="icon-check"></i>'; } else { echo '<i class="icon-check-empty"></i>'; } ?></span> Pay restaurant despite refund (e.g. this refund was our fault)
									</div>
								<?php } ?>
							<?php } ?>
							
					<br/>

					<?

						$support = Support::getSupportForOrder($order->id);
						if($suppor ) {

							if( $permissionSupportCreate ){
								echo '<i class="icon-comments"></i> <a href="/support/' . $support->id . '">View support ticket</a>';	
							}
							
						}
						else {
							if( $permissionSupportView ){
								echo '<i class="icon-comments"></i> <a href="javascript:create_support_from_order(' . $order->id . ');">Create support ticket</a>';
							}
						}
					?>
					<br/>
					<br/>
					<strong>Order #<?=$order->id?></strong><br/>
					<a target="blank" href="/vieworder/<?=$order->uuid?>">Drivers view</a><br/>
					<a target="blank" href="/vieworder/<?=$order->uuid?>/restaurant">Restaurant view</a><br/>
					<a target="blank" href="/vieworder/<?=$order->uuid?>/customer">Customer view</a>


				</td>
				<td>
					<?=$date->format('M jS Y')?><br /><br /><?=$date->format('g:i:s A')?>
				</td>
				<td nowrap="nowrap">
					<?=$order->restaurant()->name?>
					<hr/>
					<?php if( $order->restaurant()->confirmation || $order->restaurant()->hasPhoneNotification() ){
						if( $order->confirmed ) { 
							echo '<i class="icon-thumbs-up"></i> Confirmed!';
						} else {
							echo '<i class="icon-thumbs-down"></i> NOT confirmed.';
						}
						echo '<br/><br/>';
					} ?>
					<?php if( $permissionNotification ) { ?>
						<i class="icon-bullhorn"></i> <a href="javascript:;" class="resend_notification" data-confirmed="<?php echo $order->confirmed; ?>" data-uuid="<?=$order->uuid?>">Resend restaurant <br/>notification(s)</a>
					<?php } ?>
					<hr/>
					<span title="Timezone">
						<i class="icon-globe"></i> <?=$order->restaurant()->timezone?>
					</span>
				</td>
				<td style="width: 300px; white-space: normal;">
					<ul>
					<? foreach ($order->dishes() as $dish) : ?>
						<li>
							<?=$dish->dish()->name?>
							<? if ($dish->options()->count()) : ?>
								<ul>
								<? foreach ($dish->options() as $option) : ?>
									<li><?=$option->option()->name?></li>
								<? endforeach ; ?>
								<? if( $dish->id_order_dish && $dish->id_dish ){ 
										foreach ( $dish->optionsDefaultNotChoosen() as $option ) {
										?><li><i style="font-style:italic;">No <?=$option->option()->name?></i></li><?
									} 
								}?>
								</ul>
							<? endif ; ?>
						</li>
					<? endforeach ; ?>
					</ul>
				</td>
				<td style="padding:0;">
					<table style="margin:0;">
						<tr>
							<td style="border-top:0;">Subtotal</td>
							<td style="border-top:0;">$<?=number_format($order->price,2)?></td>
						</tr>
						<?php if( $order->delivery_service_markup_value > 0 ) { ?>
						<tr>
							<td nowrap="nowrap">Delivery service percent <br/>(included at subtotal) <br/>
								(+<?=$order->delivery_service_markup ? $order->delivery_service_markup : '0'?>% of $<?=number_format($order->price - $order->delivery_service_markup_value,2)?>)
							</td>
							<td>
								$<?=number_format( $order->delivery_service_markup_value, 2 )?> 
								<br/>
								(+<?=$order->delivery_service_markup ? $order->delivery_service_markup : '0'?>%)
							</td>
						</tr>
						<?php } ?>
						<tr>
							<td>Service Fee</td>
							<td>$<?=$order->serviceFee()?> ($<?=$order->service_fee ? $order->service_fee : '0'?>) </td>
						</tr>
						<tr>
							<td nowrap="">Delivery Fee</td>
							<td>$<?=$order->deliveryFee()?></td>
						</tr>
						<tr>
							<td>Tax</td>
							<td>$<?=$order->tax()?> (<?=$order->tax ? $order->tax : '0'?>%)</td>
						</tr>
						<tr>
							<td>Tip</td>
							<td>$<?=$order->tip()?> <?php if( $order->tip_type != Crunchbutton_Order::TIP_NUMBER ) { echo '(' . $order->tip . '%)'; } ?></td>
						</tr>
						<tr>
							<td>Total</td>
							<td>$<?=number_format($order->final_price,2)?></td>
						</tr>
						<?php if( $order->chargedByCredit() > 0 ) { ?>
						<tr style="background:#F5F5F5;">
							<td>Gift card</td>
							<td>$<?=$order->chargedByCredit();?></td>
						</tr>
						<tr style="background:#F5F5F5;">
							<td>Charged</td>
							<td>$<?=$order->charged();?></td>
						</tr>
						<?php } ?>
					</table>
				</td>
				<td>
					<?=$order->pay_type?>
					<br />
					<br />
					<?=$order->delivery_type?>
				</td>
				<td style="padding:0;">
					<table style="margin:0;border-top:0;width:100%;">
						<tr title="Name">
							<td style="border-top:0;"><i class="icon-user"></i> <?=$order->name?> </td>
						</tr>
						<tr title="Phone">
							<td><i class="icon-phone"> </i><?=$order->phone();?> </td>
						</tr>
						<?php if ($order->delivery_type == 'delivery') { ?>
						<tr title="Address">
							<td><i class="icon-home"></i> <?=$order->address?> </td>
						</tr>
						<?php } ?>
						<? if ($order->notes) :?>
							<tr>
								<td>
									<span>
										<i class="icon-file-alt"></i> <?php echo $order->notes;	?>
									</span>
								</td>
							</tr>
						<? endif ?>
						<?php if( $permissionGiftCard ){ ?>
						<tr>
							<td>
								<br/>
								<a href="/giftcards/new?id_user=<?php echo $order->user()->id_user; ?>&id_restaurant=<?php echo $order->restaurant()->id_restaurant; ?>&id_order_reference=<?php echo $order->id_order; ?>"><i class="icon-gift"></i> Add gift card</a>
							</td>
						</tr>
						<?php } ?>
						<?php if( $order->id_agent ) { ?>
							<tr>
								<td><i class="icon-desktop"></i> <?php echo $order->agent()->os . ' ' . $order->agent()->browser ?></td>
							</tr>
								<?php 
							} ?>
					</table>
				</td>
			</tr>
		<? endforeach ; ?>
	</table>
<? endif ; ?>