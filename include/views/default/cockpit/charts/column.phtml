<?
	// group up the data by order of data items recieved
	// 0: X
	// 1: Y
	// 2: Group

	$categories = [];
	$ys = [];
	$group = [];
	
	// set up x labels and empty objects
	foreach ($data as $item) {
		$vars = get_object_vars($item);

		// X
		$xName = key($vars);
		$x = array_shift($vars);
		$xs[$x] = true;


		$yName = key($vars);
		$y = array_shift($vars);

		$group = array_shift($vars);
		
		$ys[$group] = [];

	}
	
	foreach ($xs as $k => $v) {
		$xx .= "'".str_replace("'","\\'",$k)."', ";
	}
	$xx = substr($xx,0,-2);
	
	// fill empty columns
	foreach ($xs as $k => $v) {
		foreach ($ys as $kk => $vv) {
			$ys[$kk][$k] = 0;
		}
	}


	// gather data
	foreach ($data as $item) {
		$vars = get_object_vars($item);
		
		// X
		$x = array_shift($vars);
		$xs[$x] = true;

		// Y & group
		$y = array_shift($vars);
		
		$groupName = key($vars);
		$group = array_shift($vars);
		
		$ys[$group][$x] = $y;

	}
	
	// remove assoc vals and add proper keys
	foreach ($ys as $k => $v) {
		$ys[$k] = array_values($ys[$k]);
		$ys[$k] = [
			'name' => $k,
			'data' => $ys[$k]
		];
	}

	
	$jsData = [
		'xs' => array_keys($xs),
		'ys' => array_values($ys)
	];

?>
<div class="row-fluid">
	<div class="row-fluid">
		<div class="span12">
			<h4 style="text-align:center;"><?php echo $title; ?></h4>	
		</div>
	</div>
	<div id="chart-<?=$chartId?>" style="min-width: 100%; height:300px; margin: 0 auto"></div>
	<br/>
	<div class="row-fluid">
		<div class="span3">
			<? if( $ignoreWeekSum ){ $weeks--; } ?>
			Week <?php echo ( $weeks + 1 > $maxWeeks ) ? $maxWeeks : ( $weeks + 1 ); ?> of <?php echo $maxWeeks; ?>:
			<? if( $ignoreWeekSum ){ $weeks++; } ?>
		</div>
		<div class="span8">
			<div id="slider-<?=$chartId?>"></div>
	</div>
</div>
<hr />
<script type="text/javascript">
$(function () {
	var data = <?=json_encode($jsData, JSON_NUMERIC_CHECK)?>;
	$('#chart-<?=$chartId?>').highcharts({
		chart: {
			type: 'column',
			backgroundColor:'rgba(255, 255, 255, 0.1)'
		},
		title: {
			text: ''
		},
		xAxis: {
			categories: data.xs,
			tickmarkPlacement: 'on',
			title: {
				enabled: false
			},
			labels : {
				formatter : function(){
					return data.xs.indexOf( this.value ) + 1;
				}
			}
		},
		yAxis: {
			title: {
				text: '<?=$yName?>'
			},
			labels: {
				formatter: function() {
					return this.value;
				}
			}
		},
		tooltip: {
			shared: <?php if( $tooltipShared ){ echo 'true'; } else { echo 'false'; } ?>,
			valueSuffix: ' <?=$unit?>'
			<?php if( $tooltip ){ echo ',formatter:' . $tooltip; } ?>
		},
		plotOptions: {
			column: {
				stacking: 'normal',
				dataLabels: {
					enabled: false,
					color: ( Highcharts.theme && Highcharts.theme.dataLabelsColor ) || 'white'
				}
			}
		},
		series: data.ys
	});
	$("#slider-<?=$chartId?>").slider({
		range: "min",
		min: 1,
		max: <?php echo $maxWeeks; ?>,
		value: <?php echo $weeks; ?>,
		change: function( event, ui ) {
			console.log(ui.value);
			var self = $( '#<?=$chartId?>' );
			var id = self.attr( 'id' );
			var url = '/home/charts/' + id + '?weeks=' + ui.value;
			$.ajax( { url: url, }).done(function( data ) { self.html( data ); } );
		}
	});
});
</script>
