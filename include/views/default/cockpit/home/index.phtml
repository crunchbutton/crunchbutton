<?
	$this->title = 'Dashboard';
	$this->subtitle = 'Crunchbutton overview';
	$this->titleicon = 'dashboard';
?>


<!-- content -->
<div class="container-fluid padded">
	<div class="row-fluid">
		<div class="span3">
			<!--big normal buttons-->
			<div class="action-nav-normal">

				<div class="row-fluid">
					<div class="span6 action-nav-button">
						<a href="/restaurants/new" title="New Restaurant">
							<i class="icon-file-alt"></i>
							<span>New Restaurant</span>
						</a>
						<span class="triangle-button red"><i class="icon-plus"></i></span>
					</div>
			
					<div class="span6 action-nav-button">
						<a href="/support" title="Support">
							<i class="icon-comments-alt"></i>
							<span>Support</span>
						</a>
						<span class="label label-black"><?=$this->data['all']['tickets']?></span>
					</div>
				</div>

			
				<div class="row-fluid">
					<div class="span6 action-nav-button">
						<a href="https://github.com/crunchbutton/crunchbutton" title="Github" target="_blank">
							<i class="icon-github"></i>
							<span>Github</span>
						</a>
					</div>
			
					<div class="span6 action-nav-button">
						<a href="https://www.facebook.com/crunchbutton" title="Facebook" target="_blank">
							<i class="icon-facebook-sign"></i>
							<span>Facebook</span>
						</a>
					</div>
				</div>
			
			</div>
		</div>

		
		<div class="span9">
			
			<div class="box">
				<div class="box-header">
					<div class="title">Recent Orders</div>
					<? /*
					<ul class="box-toolbar">
						<li class="toolbar-link">
							<a href="#" data-toggle="dropdown"><i class="icon-cog"></i></a>
							<ul class="dropdown-menu">
								<li><a href="#"><i class="icon-plus-sign"></i> Add</a></li>
								<li><a href="#"><i class="icon-remove-sign"></i> Remove</a></li>
								<li><a href="#"><i class="icon-pencil"></i> Edit</a></li>
							</ul>
						</li>
					</ul>
					*/ ?>
				</div>
			
				<div class="box-content padded">
					<div class="row-fluid">
						<div class="span4 separate-sections" style="margin-top: 5px;">
			
							<div class="row-fluid">
								<div class="span12">
									<div class="dashboard-stats">
										<ul class="inline">
											<li class="glyph"><i class="icon-bolt icon-2x"></i></li>
											<li class="count"><?=$this->data['all']['orders']?></li>
										</ul>
										
										<div class="stats-label">Total Orders</div>
									</div>
								</div>
							</div>
			
							<div class="row-fluid" style="margin-top:30px;">
								<div class="span6">
									<div class="dashboard-stats small">
										<ul class="inline">
											<li class="glyph"><i class="icon-user"></i></li>
											<li class="count"><?=$this->data['week']['orders']?></li>
										</ul>
										
										<div class="stats-label">This Week</div>
									</div>
								</div>
			
								<div class="span6">
									<div class="dashboard-stats small">
										<ul class="inline">
											<li class="glyph"><i class="icon-eye-open"></i></li>
											<li class="count"><?=$this->data['day']['orders']?></li>
										</ul>
										<? /* <div class="progress progress-blue"><div class="bar tip" title="80%" data-percent="80"></div></div> */ ?>
										<div class="stats-label">Today</div>
									</div>
								</div>
							</div>
			
						</div>
						<div class="span8">
							<div class="sine-chart" id="xchart-sine"></div>
						</div>
					</div>
				</div>
				
			</div>
		</div>
	</div>

	<div class="box">
		<div class="box-header">
			<span class="title">Metrics</span>
		</div>
			<div class="box-content padded">
				<div class="row-fluid">
					<div class="span5">
						<ul class="padded separate-sections">
							<li>
								<span class="span4">
									<label for="active-user">
										<b>Active user (days)</b>
									</label>
								</span>
								<span class="span2">
									<input name="active-user-days" class="span12" id="active-user-days" type="number" placeholder="days" value="45">
								</span>
								<span class="span5">
									<button class="btn btn-blue" id="button-reload" title="Reload all charts"><i class="icon-refresh"></i></button>
									&nbsp;
									<button class="btn btn-green" id="button-open-all" title="Open all">Open all</button>
								</span>
								<div class="clearfix"></div>
							</li>
						</ul>
					</div>
					<div class="clearfix"></div>
					<hr/>
				</div>
			<?php
			$chart_count_checkbox = 0;
			$chart_count_div = 0;
			foreach ($this->graphs as $category => $graphs ){ ?>
				<h5><?php echo $category; ?></h5><?php
				$count = 1;
				foreach ($graphs as $id => $graph ){ 
					$chart_count_checkbox++;
					if( $count == 1 ){
						echo '<div class="row-fluid">';
					}
					?>
						<div class="span4">
							<div>
								<input type="checkbox" class="icheck" id="checkbox-<?php echo $id;?>-<?php echo $chart_count_checkbox; ?>" data-id="<?php echo $id;?>" data-count="<?php echo $chart_count_checkbox; ?>" name="checkbox-<?php echo $id;?>">
								<label for="checkbox-<?php echo $id;?>-<?php echo $chart_count_checkbox; ?>"><?php echo $graph; ?></label>
							</div>
						</div>
					<? 
					if( $count % 3 == 0 ){ 
						echo '</div>';
						$count = 0; 
					}
					$count++;
				} 
				if( $count != 1){
					echo '</div>';
				}
				?>
				<hr/>
					<? 
					foreach ($graphs as $id => $graph ){ 
						$chart_count_div++;
						echo '<div id="' . $id . '-' . $chart_count_div .'" data-title="'. $graph . '" data-id="'.  $id . '" data-count="' . $chart_count_div .'" class="chart" style="display:none;"><i class="icon-spinner icon-spin"></i> Loading: ' . $graph . '</div>';
					} ?>
					<hr/>
				<?php
			}
				?>
				</div>
	</div>
</div>
<script type="text/javascript">
	$( document ).ready( function(){

		$( '.icheck' ).on( 'ifChanged', function( event ){
			var check = $(this);
			var id = check.attr( 'data-id' );
			var count = check.attr( 'data-count' );
			var chartId = id + '-' + count;
			var chart = $( '#' + chartId );
			var title = check.attr( 'data-title' );
			if( check.is( ':checked' ) ){
				chart.show();
				if( !chart.attr( 'opened' ) ){
					loadChart( chartId );
				} 
			} else {
				chart.attr( 'opened', false );
				chart.hide();
			}
		});

		$( '#button-open-all' ).click( function(){
			$( '.chart' ).each( function(){
				var chart = $( this );
				loadChart( chart.attr( 'id' ) );
			} );
		} );

		$( '#button-reload' ).click( function(){
			$( '.chart' ).each( function(){
				var chart = $( this );
				if( chart.attr( 'opened' ) ){
					loadChart( chart.attr( 'id' ) );
				}
			} );
		} );
	} );

	function loadChart( chartId ){
		var chart = $( '#' + chartId );
		chart.show();
		var title = chart.attr( 'data-title' );
		var id = chart.attr( 'data-id' );
		var count = chart.attr( 'data-count' );
		var sliderValues = '';
		if( chart.attr( 'opened' ) ){
			$( '#week-' + chartId ).html( '<i class="icon-spinner icon-spin"></i>' );
			var slider = $( '#slider-' + chartId );
			slider.slider( 'disable' );
			slider.css( 'opacity', 0.4 );
			sliderValues = '&to=' + slider.attr( 'data-to' ) + '&from=' + slider.attr( 'data-from' );
		}
		chart.attr( 'opened', true );
		var activeUserDays = $( '#active-user-days' ).val();
		var url = '/home/charts/' + id + '/' + title + '/' + count + '?activeUserDays=' + activeUserDays + sliderValues;
		$.ajax( { url: url, }).done( function( data ) { chart.html( data ); } );
	}
</script>