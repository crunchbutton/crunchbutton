<?
	$this->title = 'Rules';
	$this->titleicon = 'filter';
	$this->titleLink = '/rules';
	
	$rules = $this->rules;

?>
<!-- Preview stuff -->
<div class="container-fluid padded">
	<div class="row-fluid">
		<div class="span6">
			<div class="box">
				<div class="box-header">
					<span class="title">Settings</span>
				</div>
				<div class="box-content">
					<ul class="box-list">
						<?php
						$_rules = $rules->rules();
						foreach ( $_rules as $rule => $meta ) {
							?>
								<li>
									<span><b><?php echo $meta[ 'title' ] ?></b></span>
								</li>
								<?php
								$settings = $meta[ 'settings' ];
								foreach( $settings as $key => $setting ){

									$tip = '';

									switch ( $key ) {
										case 'time':
											$title = 'Time in ' . $meta[ 'period' ] . ':';
											$type = 'numeric';
											break;
										case 'active':
											$title = 'Is rule active?';
											$type = 'checkbox';
											break;
										case 'warning-group':
											$title = 'Group name';
											$type = 'text';
											break;
										case 'warning-rep':
											$title = 'Send message to reps?';
											$type = 'checkbox';
											break;
										case 'name':
										case 'phone':
										case 'warning-phone':
										case 'warning-email':

											switch ( $key ) {
												case 'name':
													$title = 'Name(s) to monitor:';
													$tip = 'Use commas to separe names.';
													break;
												case 'phone':
													$title = 'Phone(s) to monitor:';
													$tip = 'Just numbers. Use commas to separe phones.';
													break;
												case 'warning-phone':
													$title = 'Send sms to:';
													$tip = 'Just numbers. Use commas to separe phones.';
													break;
												case 'warning-email':
													$title = 'Send email to:';
													$tip = 'Use commas to separe emails.';
													break;
											}

											
											$type = 'text';
											break;
									}
									$value = $rules->getSetting( $setting );
									?>
									<li>
										<span>
											<?php echo $title; ?>
										</span>
										
											<?php switch ( $type ) {
												case 'numeric':
													?>
													<span class="pull-right">
														<input type="number" class="settings" name="<?php echo $setting; ?>" id="<?php echo $setting; ?>" maxlength="5" value="<?php echo $value; ?>" />
													</span>
													<?php
													break;
												case 'text':
													?>
													<input type="text" class="settings" name="<?php echo $setting; ?>" id="<?php echo $setting; ?>" style="width:100%;" maxlength="250" value="<?php echo $value; ?>" />
													<?php if( $tip != '' ) { ?>
														<div class="note"><?php echo $tip; ?></div>
													<?php } ?>
													<?php
													break;
												case 'checkbox':
													$checked = ( $value == '1' ) ? 'checked="checked"' : '';
													?>
													<span class="pull-right">
														<input <?php echo $checked; ?> class="icheck settings" type="checkbox" name="<?php echo $setting; ?>" id="<?php echo $setting; ?>" maxlength="5" value="1" />
													</span>
													<?php
													break;
											} ?>
											
										
									</li>
									<?php
								}
								?><hr/><?php
						} ?>
						<li class="input">
							<button type="submit" class="btn btn-blue admin-save"><i class="icon-save"></i> Save </button> 
						</li>
					</ul>
				</div>
			</div>
		</div>
	</div>
</div>
<script type="text/javascript">

	$(function() {

		$(document).on('click', '.admin-save', function() {
			
			var data = {};

			$( '.settings' ).each( function(){
				var field = $( this );
				var value = field.val();
				if( field.is( ':checkbox' ) ){
					value = ( field.is( ':checked' ) ? 1 : 0 );
				}
				data[ field.attr( 'id' ) ] = value;
			} );

			var url = App.service + 'rules/save';
			$.ajax({
				type: "POST",
				dataType: 'json',
				data: data,
				url: url,
				success: function( json ) {
					if( json.error ){
						alert( 'Error at saving!' );
					} else {
						alert( 'Settings saved!' );
						location.href = '/rules';
					}
				},
				error: function( ){
					alert( 'Error at saving!' );
				}
			});

		} );
	} )

</script>