
	<div class="control top-bar">
		<div class="wrap order-status-init">
			<div class="status-control control-accept-reject">
				<div class="message">Accept this order?</div>
				<div class="buttons">
					<button class="button button-yes button-accept">Yes</button>
					<button class="button button-no button-reject">No</button>
				</div>
				You MUST mark orders accepted, picked up, and delivered to get paid correctly ;)
			</div>
			<div class="status-control control-rejected">
				<div class="message">You rejected. </div>
				<div class="buttons">
					<button class="button button-yes button-accept">Accept</button>
				</div>
			</div>
			<div class="status-control control-accepted">
				<div class="message">You accepted.</div>
				<div class="buttons">
					<button class="button button-yes button-pickedup">Picked up</button>
					<button class="button button-no button-reject">Cancel</button>
				</div>
			</div>
			<div class="status-control control-accepted-other">
				DO NOT DELIVER. THIS ORDER HAS ALREADY BEEN ACCEPTED BY <span class="delivery-name"></span>.
			</div>
			<div class="status-control control-pickedup">
				<div class="message">You picked up.</div>
				<div class="buttons">
					<button class="button button-yes button-delivered">Delivered</button>
				</div>
			</div>
			<div class="status-control control-pickedup-other">
				This order has been picked up by <span class="delivery-name"></span>.
			</div>
			<div class="status-control control-delivered">
				This order has been delivered by <span class="delivery-name"></span>.
			</div>
			<div class="divider"></div>
		</div>
	</div>
	
	<div class="content">
		<div class="wrap">
			<div class="status"></div>

			<div class="header">
				<div class="restaurant-name"><?=$this->order->restaurant()->name?></div>
				<div class="order-id">#<?=$this->order->id_order?></div>
				<div class="divider"></div>
			</div>

			<div class="order">
				<div class="order-item-block">
					<div class="order-icon"><i class="icon-<?=$this->order->delivery_type == 'delivery' ? 'delivery' : 'takeout'?>"></i></div>
					<div class="order-info">
						<?=$this->order->delivery_type == 'delivery' ? 'Delivery' : 'Takeout'?>
					</div>
				</div>

				<div class="order-item-block">	
					<div class="order-icon"><i class="icon-<?=$this->order->pay_type == 'card' ? 'card' : 'cash'?>"></i></div>
					<div class="order-info">
						<?=$this->order->pay_type == 'card' ? 'Card' : 'Cash'?>
					</div>
				</div>
				
				<div class="order-item-block">
					<div class="order-icon"><i class="icon-clock"></i></div>
					<div class="order-info">
						<?=$this->order->date()->format('h:i A')?>
					</div>
				</div>
				
				<div class="order-item-block">
					<div class="order-icon"><i class="icon-timer"></i></div>
					<div class="order-info">
						<? 
						if( $this->order->restaurant()->delivery_estimated_time ){
							$this->order->date()->modify('+'.$this->order->restaurant()->delivery_estimated_time.' minutes')->format('h:i A');	
						}
						 ?>
					</div>
				</div>
				

				<div class="divider"></div>

				<div class="divider dots"></div>

				<div class="order-item-block-big">
					<div class="order-info order-info-small">
						<? echo $this->order->driverInstructionsPaymentStatus(); ?>
					</div>
				</div>

				<div class="order-item-block-big">
					<div class="order-info order-info-small">
						<? echo $this->order->driverInstructionsFoodStatus(); ?>
					</div>
				</div>

				<div class="divider"></div>

				<div class="divider dots"></div>
				<br><br>
				
				<div class="order-icon"><i class="icon-user"></i></div>
				<div class="order-info">
					<?=$this->order->name?>
					<br><a href="tel:+1<?=$this->order->phone?>"><?=preg_replace('/^(\d{3})(\d{3})(\d{4})$/i', '$1-$2-$3', $this->order->phone)?></a>
				</div>

				<? if ($this->order->notes) : ?>
					<div class="order-comment-arrow"></div>
					<div class="order-comment">
						<p><?=nl2br($this->order->notes)?></p>
					</div>
				<? else : ?>
					<br>
				<? endif ; ?>

				<a href="http://maps.apple.com/?daddr=<?=$this->order->address?>&saddr=<?=$this->order->restaurant()->address?>"><div class="order-map" style="background: url('https://maps.googleapis.com/maps/api/staticmap?size=640x300&markers=color:green%7Clabel:A%7C<?=str_replace("\n",' ',str_replace('#','',$this->order->address))?>&markers=color:red%7Clabel:B%7C<?=$this->order->restaurant()->loc_lat?>,<?=$this->order->restaurant()->loc_long?>&sensor=false&visual_refresh=true');"></div></a>
						
				<br>
				
				<div class="order-item-block order-map-block">
					<div class="order-icon"><i class="icon-map-home"></i></div>
					<div class="order-info">
						<p class="order-info-address"><a href="http://maps.apple.com/?q=<?=$this->order->address?>"><?=nl2br($this->order->address)?></a></p>
					</div>
				</div>

				<div class="order-item-block order-map-block">
					<div class="order-icon"><i class="icon-map-restaurant"></i></div>
					<div class="order-info">
						<p class="order-info-address"><a href="http://maps.apple.com/?q=<?=$this->order->restaurant()->address?>"><?=nl2br($this->order->restaurant()->address)?></a></p>
					</div>
				</div>
				
				
				
				
				<br><br>
				<div class="divider dots"></div>
				<br><br>
			<? 
			$isDriverCockpit = true; 
			$delivery_service_markup = ( $this->order->delivery_service_markup ) ? $this->order->delivery_service_markup : 0;
			$order = $this->order;
			?>
			<table width="100%" celpadding="0" cellspacing="0" class="detail">
				<thead style="font-weight:bold">
					<td class="topitem">Qty</td>
					<td class="topitem">Item</td>
					<? if( $isDriverCockpit ) { ?>
					<td class="topitem" nowrap="nowrap">Customer Price</td>
					<td class="topitem" style="width:80px;font-size:12px;color:#666;">Store Price</td>
					<? } else { ?>
						<td class="topitem">Price</td>
					<? } ?>
				</thead>
				<? foreach ($order->dishes() as $dish) : ?>
					<tr>
						<td class="fooditem">1</td>
						<td class="fooditem"><?
							$food = $dish->dish()->name;
							$price = $dish->dish()->price;
							$regular_price = $dish->dish()->price;
							// add the delivery markup 
							if( $delivery_service_markup > 0 && $price > 0 ){
								$price = $price + number_format( ( $dish->dish()->price * $delivery_service_markup / 100 ), 2 );
								$price = number_format( $price, 2 );
							}
							$regular_price = number_format( $regular_price, 2 );

							$options = $dish->options();

							if (gettype($options) == 'array') {
								$options = i::o($options);
							}

							$withOptions = '';

							$selectOptions = '';

							if ($options->count()) {					

								foreach ($dish->options() as $option) {
									if ($option->option()->type == 'select') {
										continue;
									}
									$price += $option->option()->price;
									$regular_price += $option->option()->price;
									// add the delivery markup 
									if( $delivery_service_markup > 0 && $price > 0 ){
										if( $option->option()->price > 0 ){
											$option_price = number_format( ( $option->option()->price * $delivery_service_markup / 100 ), 2 );	
											$price = $price + $option_price;
										}
									}
									if($option->option()->id_option_parent) {
										$optionGroup = Crunchbutton_Option::o($option->option()->id_option_parent);
										// $withOptions .= "$optionGroup->name: ";
										if( $selectOptions == '' ){
											$selectOptions .= '&nbsp;&nbsp;';
										}
										$selectOptions .= '<i style="font-weight:600;">' . $optionGroup->name . ': ';
										$selectOptions .= $option->option()->name.', ';
									} else {
										if( $withOptions == '' ){
											$withOptions .= '<i style="font-weight:600;">&nbsp;&nbsp;With:&nbsp;';
										}
										$withOptions .= $option->option()->name.', ';
									}
									$regular_price = number_format( $regular_price, 2 );
								}
								$withOptions = substr($withOptions, 0, -2);
								$selectOptions = substr($selectOptions, 0, -2);
								if( $withOptions != '' ){
									$withOptions .= '</i>';
								}
							}

							$withoutDefaultOptions = '';
							if( $dish->id_order_dish && $dish->id_dish ){ 
								$optionsNotChoosen = $dish->optionsDefaultNotChoosen();
								$commas = ' ';
								if( $optionsNotChoosen->count() ){
									foreach( $optionsNotChoosen as $dish_option ){
										$withoutDefaultOptions .= $commas . '<i style="font-weight:600;">&nbsp;No ' . $dish_option->option()->name . '</i>';
										$commas = ', ';
									}
								}
							}

							if ( $withOptions == '' && $withoutDefaultOptions == '' && $selectOptions == '' ) {
								$food .= '.';
							} else {
								$food .= ': ';
							}

							if( $withOptions != '' ){
								$withOptions .= '.';
							}

							if( $withoutDefaultOptions != '' ){
								$withoutDefaultOptions .= '.';
							}

							if( $selectOptions != '' ){
								
								$selectOptions .= '.';
							}

							$food .= $withoutDefaultOptions;
							$food .= $withOptions;
							$food .= $selectOptions;
							?>
							<?=$food?>
						</td>
						<td style="width: 1%;" class="fooditem">
							$<? 
							if( $isRestaurant ){
								echo number_format( $regular_price, 2 );
							} else {
								echo number_format( $price, 2 );	
							}
							?>
						</td>
						<? if( $isDriverCockpit ) { ?>
						<td class="fooditem" style="font-size:12px;color:#666;">
							$<? echo number_format( $regular_price, 2 ); ?>
						</td>
						<? } ?>
					</tr>
				<? endforeach ; ?>

				<tr class="class">
					<td></td>
					<td style="text-align:right">Subtotal</td>
					<td>
					$<? 
					if( $isRestaurant ){
						// legacy
						if( intval( $delivery_service_markup ) > 0 && !$order->price_plus_delivery_markup ){
							echo number_format( $order->price - $order->delivery_service_markup_value, 2);
						} else {
							echo number_format( $order->price, 2 );
						}	
					} else {
						if( $order->price_plus_delivery_markup ){
							echo number_format( $order->price_plus_delivery_markup, 2 );		
						} else {
							echo number_format( $order->price, 2 );
						}
					}
					?>
					</td>
					<? if( $isDriverCockpit ) { ?>
					<td style="font-size:12px;color:#666;">
					$<?
					// legacy
					if( intval( $delivery_service_markup ) > 0 && !$order->price_plus_delivery_markup ){
						echo number_format( $order->price - $order->delivery_service_markup_value, 2);
					} else {
						echo number_format( $order->price, 2 );
					}
					?>
					</td>
					<? } ?>
				</tr>
				<? if ( $order->pay_type == 'card' && $order->tip ) : ?>
					<tr>
						<td></td>
						<td style="text-align:right">Tip <? if( $order->tip_type != Crunchbutton_Order::TIP_NUMBER ) { echo $order->tip . '%'; } ?></td>
						<td>$<?=$order->tip()?></td>
						<? if( $isDriverCockpit ) { ?>
						<td style="font-size:12px;color:#666;">
						
						</td>
						<? } ?>
					</tr>
				<? endif ; ?>
				<? if ( $order->restaurant()->delivery_fee ) : ?>
					<tr>
						<td></td>
						<td style="text-align:right">Delivery Fee</td>
						<td>$<?=$order->deliveryFee()?></td>
						<? if( $isDriverCockpit ) { ?>
						<td style="font-size:12px;color:#666;">
							&mdash;
						</td>
						<? } ?>
					</tr>
				<? endif ; ?>

				<? if ( $order->restaurant()->fee_customer ) : ?>
					<tr>
						<td></td>
						<td style="text-align:right">Service Fee</td>
						<td>$<?=$order->serviceFee()?></td>
						<? if( $isDriverCockpit ) { ?>
						<td style="font-size:12px;color:#666;">
							$$<?=$order->serviceFee()?>
						</td>
						<? } ?>
					</tr>
				<? endif ; ?>
				
				<tr>
					<td></td>
					<td style="text-align:right">Tax</td>
					<td>
					$<? 
					$tax = $order->tax();
					if( $isRestaurant ){
						echo number_format( $tax, 2 );
					} else {
						echo number_format( $tax, 2 );	
					}
					?>
					</td>
					<? if( $isDriverCockpit ) { ?>
					<td style="font-size:12px;color:#666;">
						$<? echo number_format( $tax, 2 ); ?>
					</td>
					<? } ?>
				</tr>

				<tr style="font-weight:bold;">
					<td></td>
					<td style="text-align:right">Total</td>
					<td>
					$<? 
					if( $isRestaurant ){
						// legacy
						if( intval( $delivery_service_markup ) > 0 && !$order->final_price_plus_delivery_markup ){
							echo number_format( $order->final_price - $order->delivery_service_markup_value, 2);
						} else {
							echo number_format( $order->final_price, 2 );
						}
					} else {
						if( $order->final_price_plus_delivery_markup ){
							echo number_format( $order->final_price_plus_delivery_markup, 2 );
						} else {
							echo number_format( $order->final_price, 2 );
						}
					}
					?>
					</td>
					<? if( $isDriverCockpit ) { ?>
					<td style="font-size:14px;color:#666;">
					$<?
					// legacy
					if( intval( $delivery_service_markup ) > 0 && !$order->final_price_plus_delivery_markup ){
						echo number_format( $order->final_price - $order->delivery_service_markup_value - $order->restaurant()->delivery_fee, 2);
					} else {
						echo number_format( $order->final_price - $order->restaurant()->delivery_fee, 2 );
					}
					?>
					</td>
					<? } ?>
				</tr>
				
				<? /* Just the user and CB will see this info about gift card. See #1006. */ ?>
				<? if( $user && $order->chargedByCredit() > 0 ) { ?>
				<tr style="font-weight:bold;">
					<td></td>
					<td style="text-align:right"><? if( $order->pay_type == 'card' ) { ?>Gift Card <? } else { ?> Already Paid by Gift Card <? } ?></td>
					<td>$<?=number_format($order->chargedByCredit(),2)?></td>
				</tr>

				<tr style="font-weight:bold;">
					<td></td>
					<td style="text-align:right"><? if( $order->pay_type == 'card' ) { ?>Total Charged <? } else { ?> Total Owed <? } ?></td>
					<td>$<?=number_format($order->charged(),2)?></td>
				</tr>
				<? } ?>

				<? if ($order->pay_type == 'card' && $order->tip == 0) : ?>
					<tr>
						<td colspan="3" style="text-align:left">Customer is tipping with cash</td>
					</tr>
				<? endif ; ?>
			</table>

			</div>
		</div>
	</div>

<script>
	$(document).ready(function(){

		var d = <?=json_encode($this->order->deliveryExports())?>;
		var id_admin = '<?=c::admin()->id_admin?>';
		var id_order = '<?=$this->order->id_order?>';
		
		var updateStatus = function(data) {
			console.log(data);
		
			$('.wrap').removeClass('order-status-init order-status-delivered order-status-pickedup order-status-rejected order-status-accepted order-status-accepted-other order-status-none');

			var className, name;

			if (data['delivery-status'].delivered) {
				className = 'order-status-delivered';
				name = data['delivery-status'].delivered.name;

			} else if (data['delivery-status'].pickedup) {
				className = 'order-status-pickedup';
				name = data['delivery-status'].pickedup.name;
		
			} else if (data['delivery-status'].accepted && data['delivery-status'].accepted.id_admin != id_admin) {
				className = 'order-status-accepted-other';
				name = data['delivery-status'].accepted.name;
		
			} else if (data['delivery-status'].accepted && data['delivery-status'].accepted.id_admin == id_admin) {
				className = 'order-status-accepted';
				name = data['delivery-status'].accepted.name;
		
			} else if (data['self-reply'] == 'rejected') {
				className = 'order-status-rejected';

			} else {
				className = 'order-status-none';
			}
			
			$('.wrap').addClass(className);
			$('.delivery-name').html(name);
			
			$('body').removeClass('loading');
		};
		
		$('.button-reject').click(function() {
			makebusy();
			$.post('/api/order/' + id_order + '/delivery-reject', updateStatus,'json');
		});

		$('.button-accept').click(function() {
			makebusy();
			$.post('/api/order/' + id_order + '/delivery-accept', updateStatus,'json');
		});
		
		$('.button-pickedup').click(function() {
			makebusy();
			$.post('/api/order/' + id_order + '/delivery-pickedup', updateStatus,'json');
		});
		
		$('.button-delivered').click(function() {
			makebusy();
			$.post('/api/order/' + id_order + '/delivery-delivered', updateStatus,'json');
		});
	
		updateStatus(d);

	} );
	
</script>	
<br/>
<br/>
<div>
	<div class="wrap show-more">
		<b><a href="/">View all orders</a></b>
	</div>
</div>	