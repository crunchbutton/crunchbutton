<?

/* Exports current community as JSON
 *
 * @todo move this to a controller
 */
if ($this->community) {
	/* @var $this->community Crunchbutton_Community */
	if ($this->admin) {
		$community = $this->community->exports();
	} else {
		$community = $this->community->exports();
	}
	$communityJson = json_encode($community);
	$communityJson = str_replace("'","\\'", $communityJson);
}

?>

<script type="text/javascript">
if (App) {
	App.config = <?=json_encode(c::appConfig())?>;
} else {
	$(function() {
		App.config = <?=json_encode(c::appConfig())?>;
	});
}
</script>

</head>

<body class="bg">
<?=$this->display('layout/html.body')?>	
</body>

<script type="text/javascript">
$(function() {
	App.aliases = <?=json_encode(Community_Alias::all(['id_community', 'prep', 'name_alt']))?>;
	App.locations = <?=json_encode(Community::all_locations())?>;
	App.facebookScope = '<?=c::config()->facebook->default->scope?>';
	App.communities = {};
	<? foreach (Community::all(c::getPagePiece(0)) as $community) : ?>
		App.communities['<?=$community->permalink?>'] = {
			<? foreach ($community->properties() as $key => $val) : ?>
				'<?=$key?>': "<?=$val?>",
			<? endforeach ; ?>
			stored: true
		};
	<? endforeach ; ?>
	<? if ($this->community && $communityJson) : ?>
		App.cached['Community'][<?=$this->community->id_community?>] = new Community(<?=$communityJson?>);
		App.cached['Community']['<?=$this->community->permalink?>'] = App.cached['Community'][<?=$this->community->id_community?>];
		<? if (!c::getPagePiece(1)) : ?>
			App.loadedPage = '<?=$this->community->permalink?>';
		<? endif ; ?>
	<? endif ; ?>

	App.topCommunities = [];
	<? foreach (Community_Alias::q('select * from community_alias where top="1" order by `sort`') as $community_alias) : ?>
		App.topCommunities[App.topCommunities.length] = {
			alias: '<?=$community_alias->alias;?>',
			name: '<?=$community_alias->name_alt;?>'
		};
	<? endforeach ; ?>
	
	App.init();
});
</script>

<script type="text/javascript">
	$(function() {
		window.fbAsyncInit = function() {
			FB.init({
				appId: '<?=Cana::config()->facebook->app?>',
				cookie: true,
				xfbml: true,
				oauth: true
			});
			var facebookService = angular.element( 'html' ).injector().get( 'FacebookService' );
			FB.getLoginStatus( facebookService.processStatus );
			FB.Event.subscribe( 'auth.statusChange', facebookService.processStatus );
		};
	});

	(function(d, s, id) {
	var js, fjs = d.getElementsByTagName(s)[0];
	if (d.getElementById(id)) return;
	js = d.createElement(s); js.id = id;
	js.src = "//connect.facebook.net/en_US/all.js";
	fjs.parentNode.insertBefore(js, fjs);
	}(document, 'script', 'facebook-jssdk'));

</script>

<? if ($_SERVER['__HTTP_HOST'] == 'crunchbutton.com') : ?>
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-36135548-1']);
		_gaq.push(['_setDomainName', 'crunchbutton.com']);
		_gaq.push(['_setAllowLinker', true]);
		_gaq.push(['_trackPageview']);
		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>
<? endif ; ?>

<script type="text/javascript">
    (function(c,a){window.mixpanel=a;var b,d,h,e;b=c.createElement("script");
    b.type="text/javascript";b.async=!0;b.src=("https:"===c.location.protocol?"https:":"http:")+
    '//cdn.mxpnl.com/libs/mixpanel-2.2.min.js';d=c.getElementsByTagName("script")[0];
    d.parentNode.insertBefore(b,d);a._i=[];a.init=function(b,c,f){function d(a,b){
    var c=b.split(".");2==c.length&&(a=a[c[0]],b=c[1]);a[b]=function(){a.push([b].concat(
    Array.prototype.slice.call(arguments,0)))}}var g=a;"undefined"!==typeof f?g=a[f]=[]:
    f="mixpanel";g.people=g.people||[];h=['disable','track','track_pageview','track_links',
    'track_forms','register','register_once','unregister','identify','alias','name_tag',
    'set_config','people.set','people.increment','people.track_charge','people.append'];
    for(e=0;e<h.length;e++)d(g,h[e]);a._i.push([b,c,f])};a.__SV=1.2;})(document,window.mixpanel||[]);
    mixpanel.init("6eb260b54eecfd293d50b5f1423c6e98");
</script>

