<div class="top-pad"></div>

<div class="content-padding">
	<h1 class="title"><i class="fa fa-bar-chart"></i>Metrics<div class="title-loader" ng-if="loading"></h1>
	<div class="box-content2">
		<form>
			<div class="ul-inputs">
			<div style="font-size:1.4em">
				<span class="label"><strong>Start: </strong></span><span class="input"><input type='date' style="font-size:1.2em;border-width:thin;border-style:solid;" ng-model='settings.start'></span>
				<span class="label"><strong>End: </strong></span><span class="input"><input type='date' style="font-size:1.2em;border-width:thin;border-style:solid;" ng-model='settings.end'></span>
				<button name='refresh' ng-click='refreshData("user requested refresh")'><i class="fa fa-refresh fa-2x"></i></button>
			</div>
			<div class="label">Communities:</div>
				
				
			<ui-select multiple ng-model="multiSelectCommunities" theme="select2" close-on-select="true" title="Select a community">
				<ui-select-match placeholder="Select a community...">{{$item.name}}</ui-select-match>
				<ui-select-choices repeat="community.id_community as community in communities | propsFilter: {name: $select.search}">
					{{community.name}}
				</ui-select-choices>
			</ui-select>
				
			<div multi-select input-model="multiSelectCommunities" button-label="name" item-label="name" tick-property="selected"
				on-item-click='updateSelected()'
				on-close='updateSelected()'
				max-labels='3' style='height:10px'></div>
			<div class="label">Period</div><div class="input"><select ng-options='period.symbol as period.description for period in availablePeriods' ng-model='settings.period' ng-change='refreshData("period change")'></select></div>
			<div class="label">Manage Charts</div>
			<button name='addChart' ng-click='addChart()'>Add Chart&nbsp;<i class="fa fa-lg fa-plus"></i></button>
			<table>
				<thead>
					<tr>
						<th></th><th></th><th>Data</th><th colspan=2>Sort</th><th ng-show='!settings.combineCharts'>Scale</th><th>Type</th><th></th>
					</tr>
				</thead>
				<tbody>
					<tr style="padding-top:1px;padding-bottom:1px;" ng-repeat='chartOption in settings.charts'>
						<td style="padding-left:3px;padding-right:3px"><i class="fa fa-lg fa-times" ng-click='removeChartOption(chartOption)'></i></td>
						<td style="padding-left:3px;padding-right:3px"><i class="fa fa-lg fa-{{chartOption.format || 'line'}}-chart"></i></td>
						<td><select ng-options='chart.type as chart.description for (t, chart) in availableCharts' ng-model='chartOption.type' ng-change='updateChartOption(chartOption)'></select></td>
						<td><select ng-options='item.kind as item.description for item in sortMethods' ng-model='chartOption.orderMethod' ng-change='updateChartOrders(chartOption, true)'></select></td>
						<td><select ng-options='item.kind as item.description for item in sortDirections' ng-model='chartOption.orderDirection' ng-change='updateChartOrders(chartOption, true)'></select></td>
						<td ng-show='!settings.combineCharts'><select ng-options='item.kind as item.description for item in setScales' ng-model='chartOption.uniformScale' ng-change='updateChartOption(chartOption)'></select></td>
						<td><select ng-options='item.kind as item.description for item in chartFormats' ng-model='chartOption.format' ng-change='persistOptions()'></select></td>
						<td style="padding-left:2px;padding-right:2px"></td>
						<td><a download="metrics-{{chartOption.type}}.csv" href="#" id='metrics-export-{{chartOption.type}}' ng-click="exportDataToCSV($event, chartOption)"><i class="fa fa-lg fa-download"></i>Export</a></td>
					</tr>
				</tbody>
			</table>
			<div><input type='checkbox' ng-model='settings.combineCharts' ng-change='calculateCombinedData()'>Combine Charts</input></div>
			<? /* i dont know why even want this option
			<div><input type='checkbox' ng-model='settings.showEmpty' ng-change='showEmptyChanged()'>Show Empty Charts</input></div>
			*/ ?>
			</div>
		</form>
	</div>
	
<div class="support-boxes metrics-boxes">
	<div ng-if='!settings.combineCharts' ng-repeat='community in orderedCommunities' class="support-box-wrap box-content2">
		<div class="support-box-wrap-header">
			<h1>{{community.name}}</h1>
			<div class="divider"></div>
		</div>

		<div ng-repeat='chartOption in settings.charts' ng-switch on='chartOption.format'>
			<h3 style='text-align:center' ng-if="settings.charts.length > 1">{{availableCharts[chartOption.type].description}}</h3>
			<canvas ng-switch-when='line' class="chart chart-line" data="chartData[community.id_community][chartOption.type].data"
				options="chartData[community.id_community][chartOption.type].options"
				labels="chartData[community.id_community][chartOption.type].labels"
				legend="false"></canvas>
			<canvas ng-switch-when='bar' class="chart chart-bar" data="chartData[community.id_community][chartOption.type].data"
				options="chartData[community.id_community][chartOption.type].options"
				labels="chartData[community.id_community][chartOption.type].labels"
				legend="false"></canvas>
		</div>
	</div>
	</div>
	<div ng-if='settings.combineCharts' ng-repeat='chartOption in settings.charts' ng-switch on='chartOption.format'>
		<h3 style='text-align:center'>{{availableCharts[chartOption.type].description}}</h3>
		<canvas ng-switch-when='line' ng-if='orderedCommunities.length <= settings.maxCombinedCommunities'
			class="chart chart-line" data="combinedChartData[chartOption.type].data"
			options="combinedChartData[chartOption.type].options"
			labels="combinedChartData[chartOption.type].labels"
			series="combinedChartData[chartOption.type].series"
			legend="true"></canvas>
		<canvas ng-switch-when='bar' ng-if='orderedCommunities.length <= settings.maxCombinedCommunities'
			class="chart chart-bar" data="combinedChartData[chartOption.type].data"
			options="combinedChartData[chartOption.type].options"
			labels="combinedChartData[chartOption.type].labels"
			series="combinedChartData[chartOption.type].series"
			legend="true"></canvas>
		<div ng-if='orderedCommunities.length > settings.maxCombinedCommunities'>
			<p>Too many communities to show combined chart.</p>
			<p>(select at most {{settings.maxCombinedCommunities}})</p>
		</div>
	</div>
</div>
<small>persistence: {{serializedSettings}}. round tripped: {{roundTrippedSerialized}}</small>
<div><small><button ng-click='resetSettings()'>Reset To Default Settings</button></small></div>
