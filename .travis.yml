language:
  - php

php:
  - 5.4
  #- 5.6.9
#  - 5.5.21
#  - 5.6.7
# add this when we move to heroku

env:
  - TRAVIS=1
  - TRAVIS=1 TRAVISPOSTGRES=1
  
# install:

before_script:
  - mkdir build
  - composer install --dev --no-interaction
  - mysql -e "create database IF NOT EXISTS crunchbutton_travis;" -uroot;
  - mysql -uroot crunchbutton_travis < db/dump.sql;
  - phpenv config-add travis/php.ini
  - php travis/dbmigrate.php
  - sudo apt-get clean
  - sudo apt-get update
  - sudo apt-get install apache2
  - sudo a2enmod actions
  - sudo a2enmod rewrite
  - travis/mysql-to-postgres.sh
  - chmod -R 0777 ./*
  - echo "export PATH=/home/travis/.phpenv/bin:$PATH" | sudo tee -a /etc/apache2/envvars > /dev/null
  - cat travis/apache.conf | sudo tee /etc/apache2/conf.d/phpconfig > /dev/null
  - cat travis/sites.conf | sed -e "s,PATH,`pwd`/www,g" | sudo tee /etc/apache2/sites-available/default > /dev/null
  - echo 'export APACHE_ARGUMENTS="-D TRAVIS"' | sudo tee -a /etc/apache2/envvars > /dev/null
  - sudo service apache2 restart
  - npm install assert chai phantom path util events
  
#  - "export DISPLAY=:99.0"
#  - "sh -e /etc/init.d/xvfb start"
#  - sleep 3
#  - sudo rackup
#  - sleep 3


script:
  - phpunit --configuration travis/phpunit.xml
  - phantomjs --web-security=false --ignore-ssl-errors=yes --ssl-protocol=tlsv1 travis/phantom/run.js
  
notifications:
  webhooks: https://cockpit.la/api/travisci/build

addons:
  postgresql: "9.3"
#  apt:
#    packages:
#    - cmake
#    - time
#  sauce_connect:
#  username: "Your Sauce Labs username"
#  access_key: "Your Sauce Labs access key"

after_script:
  - php vendor/bin/coveralls -v